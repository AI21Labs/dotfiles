# 077 would be more secure, but 022 is generally quite realistic
umask 022

# Save more history
export HISTSIZE=10000
export SAVEHIST=10000

# OS variables
[ $(uname -s) = "Darwin" ] && export OSX=1
[ $(uname -s) = "Linux" ] && export LINUX=1
uname -s | grep -q "_NT-" && export WINDOWS=1

# Fix systems missing $USER
[ -z "$USER" ] && export USER=$(whoami)

# Colourful manpages
export LESS_TERMCAP_mb=$'\E[01;31m'
export LESS_TERMCAP_md=$'\E[01;31m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;44;33m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[01;32m'

# Set to avoid `env` output from changing console colour
export LESS_TERMEND=$'\E[0m'

# Qt development
export QTEST_COLORED=1

# Count CPUs for Make jobs
if [ $OSX ]
then
	export CPUCOUNT=$(sysctl -n hw.ncpu)
elif [ $LINUX ]
then
	export CPUCOUNT=$(getconf _NPROCESSORS_ONLN)
else
	export CPUCOUNT="1"
fi

if [ "$CPUCOUNT" -gt 1 ]
then
	export MAKEFLAGS="-j$CPUCOUNT"
fi

# Load GitHub token
[ -s ~/.github.token ] && export GITHUB_TOKEN=$(cat ~/.github.token)

# Print field by number
field() {
	awk {print\ \$$1}
}

# Setup paths
export PATH=$PATH:vendor/ruby/bin

add_to_path_start() {
	[ -d $1 ] && export PATH="$1:$PATH"
}

add_to_path() {
	[ -d $1 ] && export PATH="$PATH:$1"
}

add_to_path_start /usr/local/bin
add_to_path_start /usr/local/sbin
add_to_path $HOME/Documents/Scripts
add_to_path $HOME/Documents/Scripts/ignored
add_to_path $HOME/Documents/Scripts/thirdparty
add_to_path $HOME/Scripts
add_to_path $HOME/Scripts/ignored
add_to_path $HOME/Scripts/thirdparty
add_to_path $HOME/Library/Python/2.7/bin

quiet_which() {
	which $1 1>/dev/null 2>/dev/null
}

quiet_which ack-grep && alias ack=ack-grep
export DIFF=diff
if quiet_which colordiff
then
	export DIFF=colordiff
	alias diff=colordiff
fi

quiet_which vim && export EDITOR="vim"

if quiet_which mate
then
	export EDITOR="mate"
	export GIT_EDITOR="$EDITOR --name 'Git Commit Message' -w -l1"
	export SVN_EDITOR="$EDITOR --name 'Subversion Commit Message' -w -l1"
fi

# Aliases
alias su="/bin/su -"
alias mkdir="mkdir -vp"
alias df="df -H"
alias rm="rm -iv"
alias mv="mv -iv"
alias cp="cp -irv"
alias du="du -sh"
alias make="nice make"
alias ps="ps aux"
alias less="less --ignore-case --raw-control-chars"
alias rsync="rsync --partial --progress --human-readable --compress"

alias upmike="scp-to-http.sh mike mikemcquaid.com Sites"
alias upbrew="scp-to-http.sh mikemcquaid,machomebrew frs.sourceforge.net /home/frs/project/m/ma/machomebrew/Bottles https://downloads.sf.net/project/machomebrew/Bottles"

alias svn="svn-git.sh"

alias be="bundle exec"

# Platform-specific stuff
if [ -n "${SSH_CONNECTION}" ] && quiet_which rmate
then
	export EDITOR="rmate"
	export GIT_EDITOR="$EDITOR -w"
	export SVN_EDITOR=$GIT_EDITOR
fi

if quiet_which brew
then
	export BREW_PREFIX=$(brew --prefix)
	export ANDROID_SDK_ROOT=$(brew --prefix android-sdk)
	alias brew="nice brew"
	alias bpi="brew pull --install"
fi

if [ $OSX ]
then
	export GREP_OPTIONS="--color=auto"
	export CLICOLOR
	export CC="clang"
	export CXX="clang++"

	add_to_path $HOME/Documents/Scripts/thirdparty/osx
	add_to_path /Applications/Xcode.app/Contents/Developer/usr/bin

	alias ls="ls -F"
	alias ql="qlmanage -p 1>/dev/null"
	alias locate="mdfind -name"

elif [ $LINUX ]
then
	add_to_path $HOME/QtSDK/Desktop/Qt/4.8.1/gcc/bin
	quiet_which keychain && eval `keychain -q --eval --agents ssh id_rsa`

	alias ls="ls -F --color=auto"
	alias open="xdg-open"
	alias agdu="sudo apt-get dist-upgrade"
	alias mate="$EDITOR"
elif [ $WINDOWS ]
then
	quiet_which plink && alias ssh="plink -l mike"

	alias ls="ls -F --color=auto"
	alias mate="$EDITOR"

	open() {
		cmd /C"$@"
	}
fi

# Run dircolors if it exists
quiet_which dircolors && eval $(dircolors -b)

# Run rbenv if it exists
quiet_which rbenv && eval "$(rbenv init -)"

# Aliases using variables
alias ed="$EDITOR"

# Load last directory
cd() {
	builtin cd "$@" || return
	ls
	pwd > ~/.lastpwd
}
