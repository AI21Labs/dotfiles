# 077 would be more secure, but 022 is generally quite realistic
umask 022

# OS variables
[ $(uname -s) = "Darwin" ] && export OSX=1
[ $(uname -s) = "Linux" ] && export LINUX=1
uname -s | grep -q "_NT-" && export WINDOWS=1

# Fix systems missing $USER
[ -z "$USER" ] && export USER=$(whoami)

# Colourful manpages
export LESS_TERMCAP_mb=$'\E[01;31m'
export LESS_TERMCAP_md=$'\E[01;31m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;44;33m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[01;32m'

# Set to avoid `env` output from changing console colour
export LESS_TERMEND=$'\E[0m'

# Qt development
export QTEST_COLORED=1

# KDAB development
export KDABSVN='svn+ssh://mike@svn.kdab.com/home/SVN-klaralv'
export KDABGIT='gitolite@git.kdab.com'

# Setup paths
add_to_path() {
	[ -d $1 ] && export PATH="$1:$PATH"
}

add_to_path /usr/local/bin
add_to_path /usr/local/sbin
add_to_path $HOME/Documents/KDAB/Scripts
add_to_path $HOME/Documents/Scripts
add_to_path $HOME/Scripts
add_to_path $HOME/.gem/ruby/1.8/bin

# Count CPUs for Make jobs
if [ $OSX ]
then
	export CPUCOUNT=$(sysctl -n hw.ncpu)
elif [ $LINUX ]
then
	export CPUCOUNT=$(getconf _NPROCESSORS_ONLN)
else
	export CPUCOUNT="1"
fi

if [ "$CPUCOUNT" -gt 1 ]
then
	export MAKEFLAGS="-j$CPUCOUNT"
fi

# Aliases
alias su="/bin/su -"
alias mkdir="mkdir -vp"
alias df="df -H"
alias rm="rm -iv"
alias mv="mv -iv"
alias cp="cp -irv"
alias du="du -sh"
alias make="nice make"
alias ps="ps aux"
alias less="less -ir"

quiet_which() {
	which $@ 1>/dev/null 2>/dev/null
}

quiet_which ack-grep && alias ack=ack-grep
if quiet_which colordiff
then
	export DIFF=colordiff
	alias diff=colordiff
else
	export DIFF=diff
fi

alias upkdab="scp-to-http.sh mike swanson.kdab.com public_html"
alias upjoanna="scp-to-http.sh mike www.kdab.com public_html"
alias upmike="scp-to-http.sh mike mikemcquaid.com Sites"
alias upbrew="scp-to-http.sh mikemcquaid,machomebrew frs.sourceforge.net /home/frs/project/m/ma/machomebrew/Bottles https://downloads.sourceforge.net/project/machomebrew/Bottles"

alias ssh="ssh-with-agent.sh"
alias scp="SSH_COMMAND=scp ssh-with-agent.sh -r"

alias svn="svn-git.sh"

field() {
	awk {print\ \$$1}
}

# Platform-specific stuff
export EDITOR="vim"

if [ $OSX ]
then
	if [ -n "${DISPLAY}" ]
	then
		export EDITOR="mate"
		export GIT_EDITOR="mate -w -l0"
		export SVN_EDITOR=$GIT_EDITOR
	fi
	export GREP_OPTIONS="--color=auto"
	export CLICOLOR
	alias ls="ls -F"
	alias brew="nice brew"
	alias bpi="brew pull --install"
	alias ql="qlmanage -p 1>/dev/null"
	alias locate="mdfind -name"
elif [ $LINUX ]
then
	alias ls="ls -F --color=auto"
    alias open="xdg-open"
elif [ $WINDOWS ]
then
	alias ls="ls -F --color=auto"
	open() {
		cmd /C"$*"
	}

fi

# Run dircolors if it exists
quiet_which dircolors && eval $(dircolors -b)

# Aliases using variables
alias ed="$EDITOR"
